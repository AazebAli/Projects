<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analyzer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #121212;
            --paper-dark: #1e1e1e;
            --paper-light: #2a2a2a;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-grey: #444;
            --accent-gold: #c5a059;
            --highlight: #3a3a3a;
            --success-green: #4caf50;
            --alert-red: #e53935;
        }

        body {
            font-family: 'Merriweather', serif;
            /* Classic Serif */
            background-color: var(--ink-black);
            color: var(--text-main);
            margin: 0;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2H0v-2h20v-2H0V8h20V6H0V4h20V2H0V0h22v20h2V0h2v20h2V0h2v20h2V0h2v20h2v2H22v-2h-2z' fill='%231a1a1a' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* --- Header: The Masthead --- */
        header {
            background-color: var(--paper-dark);
            border-bottom: 3px double var(--border-grey);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-main);
            text-shadow: 2px 2px 0px #000;
        }

        #userInfo {
            font-family: 'Merriweather', serif;
            font-style: italic;
            color: var(--accent-gold);
        }

        #logoutBtn {
            background: transparent;
            border: 1px solid var(--border-grey);
            color: var(--text-muted);
            font-family: 'Merriweather', serif;
            padding: 5px 15px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        #logoutBtn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* --- Layout --- */
        .container {
            max-width: 900px;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        .card {
            background: var(--paper-dark);
            border: 1px solid var(--border-grey);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.3);
            /* Brutalist shadow */
        }

        h2 {
            font-family: 'Playfair Display', serif;
            margin-top: 0;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-grey);
            padding-bottom: 10px;
            font-size: 1.8rem;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--accent-gold);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: var(--paper-light);
            border: 1px solid var(--border-grey);
            color: var(--text-main);
            font-family: 'Merriweather', serif;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: #333;
        }

        /* --- Buttons --- */
        .btn {
            background-color: var(--text-main);
            color: var(--ink-black);
            border: none;
            padding: 12px 24px;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn:hover {
            background-color: var(--accent-gold);
            color: #000;
            box-shadow: 3px 3px 0px rgba(255, 255, 255, 0.1);
        }

        .btn:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            border: 1px solid #555;
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
        }

        .btn-secondary:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        /* --- Auth Page --- */
        #authSection {
            max-width: 450px;
            margin: 5rem auto;
            text-align: center;
        }

        .toggle-link {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--accent-gold);
            cursor: pointer;
            text-decoration: underline;
            font-style: italic;
        }

        .toggle-link:hover {
            color: var(--text-main);
        }

        .job-item {
            border-bottom: 1px solid var(--border-grey);
            padding: 2rem 0;
            transition: background 0.2s;
        }

        .job-item:last-child {
            border-bottom: none;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
        }

        .job-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
            font-family: 'Playfair Display', serif;
        }

        .job-meta {
            font-size: 0.85rem;
            color: var(--accent-gold);
            font-style: italic;
        }

        .job-content {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        .result-box {
            background: var(--paper-light);
            border: 1px solid var(--border-grey);
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
            border-left: 4px solid var(--accent-gold);
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            font-size: 0.9rem;
            border: 1px solid;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .score-high {
            color: var(--success-green);
            border-color: var(--success-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .score-med {
            color: var(--accent-gold);
            border-color: var(--accent-gold);
            background: rgba(197, 160, 89, 0.1);
        }

        .score-low {
            color: var(--alert-red);
            border-color: var(--alert-red);
            background: rgba(229, 57, 53, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .error-msg {
            color: var(--alert-red);
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>

<body>

    <header id="mainHeader" class="hidden">
        <h1>Resume Analyzer</h1>
        <div id="userInfo">
            <span id="userNameDisplay"></span>
            <button id="logoutBtn" onclick="logout()">Sign Out</button>
        </div>
    </header>

    <div id="authSection">
        <div id="loginCard" class="card">
            <h2 class="text-center">Member Login</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUser">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPass">
            </div>
            <button class="btn" style="width: 100%" onclick="login()">Enter System</button>
            <div id="loginError" class="error-msg"></div>
            <div class="toggle-link" onclick="toggleAuth('register')">New here? Register an account.</div>
        </div>

        <div id="registerCard" class="card hidden">
            <h2 class="text-center">New Registration</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="regUser">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="regEmail">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="regPass">
            </div>
            <div class="form-group">
                <label>Account Type</label>
                <select id="regRole">
                    <option value="CANDIDATE">Candidate (Job Seeker)</option>
                    <option value="RECRUITER">Recruiter (Hiring Manager)</option>
                </select>
            </div>
            <button class="btn" style="width: 100%" onclick="register()">Create Profile</button>
            <div id="regError" class="error-msg"></div>
            <div class="toggle-link" onclick="toggleAuth('login')">Existing user? Login here.</div>
        </div>
    </div>

    <div id="recruiterDashboard" class="container hidden">
        <div class="card">
            <h2>Publish New Vacancy</h2>
            <div class="form-group">
                <label>Position Title</label>
                <input type="text" id="jobTitle" placeholder="e.g. Lead Editor">
            </div>
            <div class="form-group">
                <label>Job Description & Requirements</label>
                <textarea id="jobContent" placeholder="Describe the role..."></textarea>
            </div>
            <button class="btn" onclick="postJob()">Publish Job</button>
        </div>

        <div class="card">
            <h2>Active Listings</h2>
            <div id="recruiterJobList"></div>
        </div>
    </div>

    <div id="candidateDashboard" class="container hidden">

        <div class="card">
            <h2>1. File Dossier</h2>
            <p style="color:var(--text-muted); margin-bottom: 1rem; font-style: italic;">Upload your Curriculum Vitae
                (PDF) to begin.</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="resumeFile" accept=".pdf">
                <button class="btn" onclick="uploadResume()">Upload PDF</button>
            </div>
            <div id="uploadStatus" style="margin-top: 15px; font-weight: bold; color: var(--accent-gold);"></div>
        </div>

        <div class="card">
            <h2>2. Classifieds</h2>
            <p style="color:var(--text-muted); margin-bottom: 1rem; font-style: italic;">Select a position to run the
                analysis engine.</p>
            <div id="candidateJobList"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentResumeId = null;

        function toggleAuth(mode) {
            document.getElementById('loginCard').classList.toggle('hidden', mode === 'register');
            document.getElementById('registerCard').classList.toggle('hidden', mode === 'login');
            document.getElementById('loginError').innerText = '';
            document.getElementById('regError').innerText = '';
        }

        async function login() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (res.ok) {
                    currentUser = await res.json();
                    initDashboard();
                } else {
                    document.getElementById('loginError').innerText = "Credentials Invalid.";
                }
            } catch (e) { document.getElementById('loginError').innerText = "System Error."; }
        }

        async function register() {
            const username = document.getElementById('regUser').value;
            const password = document.getElementById('regPass').value;
            const email = document.getElementById('regEmail').value;
            const role = document.getElementById('regRole').value;
            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email, role })
                });
                if (res.ok) {
                    alert("Registration successful.");
                    toggleAuth('login');
                } else {
                    document.getElementById('regError').innerText = await res.text();
                }
            } catch (e) { document.getElementById('regError').innerText = "Registration failed."; }
        }

        function logout() {
            currentUser = null;
            currentResumeId = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('recruiterDashboard').classList.add('hidden');
            document.getElementById('candidateDashboard').classList.add('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        }

        function initDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = `${currentUser.username} — ${currentUser.role}`;

            if (currentUser.role === 'RECRUITER') {
                document.getElementById('recruiterDashboard').classList.remove('hidden');
                loadJobsForRecruiter();
            } else {
                document.getElementById('candidateDashboard').classList.remove('hidden');
                loadAllJobs();
            }
        }

        async function postJob() {
            const title = document.getElementById('jobTitle').value;
            const content = document.getElementById('jobContent').value;
            if (!title || !content) return alert("Fields cannot be empty.");

            const res = await fetch(`/api/jobs/post/${currentUser.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });

            if (res.ok) {
                alert("Vacancy Published.");
                document.getElementById('jobTitle').value = '';
                document.getElementById('jobContent').value = '';
                loadJobsForRecruiter();
            }
        }

        async function loadJobsForRecruiter() {
            const res = await fetch('/api/jobs/all');
            const jobs = await res.json();
            const container = document.getElementById('recruiterJobList');
            container.innerHTML = '';
            const myJobs = jobs.filter(j => j.recruiter && j.recruiter.id === currentUser.id);

            if (myJobs.length === 0) container.innerHTML = '<p style="font-style:italic; color:var(--text-muted);">No vacancies published.</p>';

            myJobs.forEach(job => {
                const div = document.createElement('div');
                div.className = 'job-item';
                div.innerHTML = `
                    <div class="job-header">
                        <span class="job-title">${job.title}</span>
                        <span class="job-meta">Pub: ${new Date(job.postedAt).toLocaleDateString()}</span>
                    </div>
                    <p class="job-content">${job.content.substring(0, 150)}...</p>
                    <button class="btn btn-secondary" onclick="viewCandidates(${job.id})">Review Dossiers</button>
                    <div id="candidates-${job.id}" class="result-box"></div>
                `;
                container.appendChild(div);
            });
        }

        async function viewCandidates(jobId) {
            const box = document.getElementById(`candidates-${jobId}`);
            box.style.display = 'block';
            box.innerHTML = '<div style="color:var(--text-muted); font-style:italic;">Retrieving Archives...</div>';

            try {
                const res = await fetch(`/api/jobs/${jobId}/candidates`);
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Server Error (${res.status}): ${errorText}`);
                }
                const reports = await res.json();

                if (reports.length === 0) {
                    box.innerHTML = '<p style="font-style:italic;">No applicants found.</p>';
                    return;
                }

                let html = '<h4 style="margin-top:0; border-bottom:1px dashed var(--accent-gold); padding-bottom:5px;">Applicant Rankings</h4>';
                reports.forEach(r => {
                    const candidateName = r.resume ? (r.resume.fileName || 'Unknown') : 'Unknown File';
                    const score = r.matchScore ? r.matchScore.toFixed(1) : '0.0';
                    let badgeClass = score > 80 ? 'score-high' : (score > 50 ? 'score-med' : 'score-low');

                    html += `
                        <div style="background:var(--paper-dark); border:1px solid var(--border-grey); padding: 15px; margin-bottom: 10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <strong style="color:var(--text-main); font-family:'Playfair Display', serif;">${candidateName}</strong>
                                <span class="score-badge ${badgeClass}">${score}% Match</span>
                            </div>
                            <div style="font-size:0.9rem; color:var(--text-muted); font-style:italic;">
                                ${r.feedback ? r.feedback.replace(/\n/g, '<br>') : 'No analysis available.'}
                            </div>
                        </div>
                    `;
                });
                box.innerHTML = html;
            } catch (e) {
                box.innerHTML = `<div class="error-msg">System Malfunction: ${e.message}</div>`;
            }
        }

        async function uploadResume() {
            const fileInput = document.getElementById('resumeFile');
            if (!fileInput.files[0]) return alert("Select a document.");
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const res = await fetch(`/api/resume/upload/${currentUser.id}`, {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                const text = await res.text();
                const match = text.match(/ID:\s*(\d+)/);
                if (match) {
                    currentResumeId = match[1];
                    document.getElementById('uploadStatus').innerText = "✓ Dossier Filed Successfully.";
                }
            } else { alert("Filing failed."); }
        }

        async function loadAllJobs() {
            const res = await fetch('/api/jobs/all');
            const jobs = await res.json();
            const container = document.getElementById('candidateJobList');
            container.innerHTML = '';

            if (jobs.length === 0) container.innerHTML = '<p style="font-style:italic;">No classifieds available.</p>';

            jobs.forEach(job => {
                const div = document.createElement('div');
                div.className = 'job-item';
                div.innerHTML = `
                    <div class="job-header">
                        <span class="job-title">${job.title}</span>
                        <span class="job-meta">Hiring: ${job.recruiter ? job.recruiter.username : 'Unknown'}</span>
                    </div>
                    <p class="job-content">${job.content}</p>
                    <button class="btn" onclick="applyToJob(${job.id}, this)">Run Analysis & Apply</button>
                    <div class="result-box"></div>
                `;
                container.appendChild(div);
            });
        }

        async function applyToJob(jobId, btn) {
            if (!currentResumeId) return alert("Please file your dossier (Upload PDF) first.");
            btn.disabled = true;
            btn.innerText = "Processing...";
            const resultBox = btn.nextElementSibling;
            resultBox.style.display = 'block';
            resultBox.innerText = "Consulting Analytical Engine...";

            try {
                const res = await fetch(`/api/resume/apply/${jobId}/${currentResumeId}`, { method: 'POST' });
                if (res.ok) {
                    const report = await res.json();
                    let badgeClass = report.matchScore > 80 ? 'score-high' : (report.matchScore > 50 ? 'score-med' : 'score-low');
                    resultBox.innerHTML = `
                        <div style="margin-top:10px;">
                            <span class="score-badge ${badgeClass}" style="font-size:1.1rem; padding: 8px 15px;">
                                Rating: ${report.matchScore.toFixed(1)}%
                            </span>
                        </div>
                        <div style="margin-top:15px; white-space: pre-wrap; font-family:'Merriweather', serif;">${report.feedback}</div>
                    `;
                } else { resultBox.innerText = "Analysis Failed."; }
            } catch (e) { resultBox.innerText = "Connection Error."; }
            finally { btn.innerText = "Application Filed"; }
        }
    </script>
</body>

</html>